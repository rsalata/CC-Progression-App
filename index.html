<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="CC PRO">
  <meta name="theme-color" content="#080808">
  <title>CC PROGRESSION</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #080808;
      --surface:   #111111;
      --surface2:  #1a1a1a;
      --border:    #242424;
      --border2:   #2e2e2e;
      --text:      #e2e2e2;
      --text-dim:  #666;
      --text-mute: #333;
      --gold:      #c8a05a;
      --gold-dim:  rgba(200,160,90,0.15);
      --green:     #2ec278;
      --green-dim: rgba(46,194,120,0.12);
      --yellow:    #e8a830;
      --yellow-dim:rgba(232,168,48,0.12);
      --red:       #e04848;
      --red-dim:   rgba(224,72,72,0.12);
      --radius:    4px;
      --safe-top:  env(safe-area-inset-top, 0px);
      --safe-bot:  env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      max-width: 500px;
      margin: 0 auto;
      position: relative;
    }

    /* ── SCREENS ── */
    .screens {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .screen {
      position: absolute;
      inset: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding-top: calc(var(--safe-top) + 0px);
      padding-bottom: 80px;
      display: none;
      -webkit-overflow-scrolling: touch;
    }

    .screen.active { display: block; }

    /* ── NAV ── */
    .bottom-nav {
      display: flex;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding-bottom: var(--safe-bot);
      position: relative;
      z-index: 100;
      flex-shrink: 0;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 4px;
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: color 0.15s;
      gap: 4px;
    }

    .nav-btn.active { color: var(--gold); }

    .nav-btn svg {
      width: 20px;
      height: 20px;
      opacity: 0.7;
      transition: opacity 0.15s;
    }

    .nav-btn.active svg { opacity: 1; }

    /* ── SECTION HEADER ── */
    .screen-header {
      padding: 20px 20px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .phase-tag {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.12em;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .screen-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.02em;
      line-height: 1;
    }

    .screen-subtitle {
      font-size: 13px;
      color: var(--text-dim);
      margin-top: 4px;
      font-weight: 400;
    }

    /* ── IN-CARD LEVEL STEPPER ── */
    .card-level-stepper {
      margin-bottom: 14px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .cls-label {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-mute);
      padding: 7px 12px 0;
    }

    .cls-controls {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .cls-btn {
      background: none;
      border: none;
      color: var(--gold);
      font-size: 20px;
      font-weight: 700;
      width: 44px;
      min-height: 64px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.1s, opacity 0.15s;
      font-family: 'JetBrains Mono', monospace;
    }

    .cls-btn:active { background: var(--border2); }
    .cls-btn:disabled { color: var(--text-mute); cursor: default; }

    .cls-display {
      flex: 1;
      text-align: center;
      padding: 8px 4px;
    }

    .cls-num {
      font-family: 'JetBrains Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      line-height: 1;
      margin-bottom: 4px;
    }

    .cls-of {
      font-size: 13px;
      color: var(--text-mute);
      font-weight: 400;
    }

    .cls-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .cls-desc {
      font-size: 11px;
      color: var(--text-dim);
      font-style: italic;
      line-height: 1.3;
      padding: 0 4px;
    }

    /* ── WORKOUT CARDS ── */
    .workout-list {
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .workout-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      user-select: none;
      gap: 12px;
    }

    .card-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.14em;
      color: var(--text-dim);
      text-transform: uppercase;
      width: 52px;
      flex-shrink: 0;
    }

    .card-name {
      flex: 1;
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .card-desc {
      font-size: 11px;
      color: var(--text-dim);
      font-weight: 400;
      margin-top: 1px;
      margin-bottom: 2px;
      font-style: italic;
    }

    .card-level {
      font-size: 11px;
      color: var(--gold);
      font-weight: 500;
      letter-spacing: 0.06em;
    }

    .card-chevron {
      color: var(--text-mute);
      font-size: 14px;
      transition: transform 0.2s;
    }

    .card-chevron.open { transform: rotate(180deg); }

    .card-body {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--border);
    }

    .card-body.open { display: block; }

    .target-line {
      font-size: 12px;
      color: var(--text-dim);
      padding: 10px 0 14px;
      letter-spacing: 0.04em;
    }

    .target-line strong { color: var(--text); font-weight: 600; }

    /* ── SET INPUTS ── */
    .sets-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }

    .set-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .set-label {
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 0.08em;
      font-weight: 600;
      text-transform: uppercase;
      text-align: center;
    }

    .set-input {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      padding: 10px 4px;
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      transition: border-color 0.15s;
    }

    .set-input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .set-input.time-input { font-size: 22px; }

    /* ── PAIN SLIDER ── */
    .pain-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .pain-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      width: 54px;
      flex-shrink: 0;
    }

    .pain-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .pain-value.low  { color: var(--green); }
    .pain-value.mid  { color: var(--yellow); }
    .pain-value.high { color: var(--red); }

    input[type=range] {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 3px;
      background: var(--border2);
      border-radius: 2px;
      outline: none;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--gold);
      cursor: pointer;
    }

    input[type=range].low-range::-webkit-slider-thumb  { background: var(--green); }
    input[type=range].mid-range::-webkit-slider-thumb  { background: var(--yellow); }
    input[type=range].high-range::-webkit-slider-thumb { background: var(--red); }

    /* ── FINISH BUTTON ── */
    .finish-area {
      padding: 16px;
    }

    .btn-primary {
      width: 100%;
      background: var(--gold);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 16px;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }

    .btn-primary:active { opacity: 0.85; transform: scale(0.99); }

    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 12px 20px;
      cursor: pointer;
    }

    /* ── MODAL ── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 200;
      display: flex;
      align-items: flex-end;
      display: none;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border-top: 1px solid var(--border2);
      border-radius: 12px 12px 0 0;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding: 24px 20px;
      padding-bottom: calc(24px + var(--safe-bot));
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      margin-bottom: 20px;
    }

    .quality-btns {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 12px 0 20px;
    }

    .q-btn {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      color: var(--text-dim);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      padding: 12px 8px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.15s;
    }

    .q-btn.selected { border-color: var(--gold); color: var(--gold); background: var(--gold-dim); }

    textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      color: var(--text);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 15px;
      padding: 12px;
      resize: none;
      height: 72px;
      margin-bottom: 16px;
    }

    textarea:focus { outline: none; border-color: var(--gold); }

    /* ── PROGRESS SCREEN ── */
    .progress-section {
      padding: 16px;
    }

    .status-banner {
      border-radius: var(--radius);
      padding: 16px 18px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-banner.ready {
      background: var(--green-dim);
      border: 1px solid var(--green);
    }

    .status-banner.not-ready {
      background: var(--surface);
      border: 1px solid var(--border2);
    }

    .status-text {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.10em;
      text-transform: uppercase;
    }

    .status-banner.ready   .status-text { color: var(--green); }
    .status-banner.not-ready .status-text { color: var(--text-dim); }

    .status-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-dim);
    }

    .metric-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      margin-bottom: 8px;
    }

    .metric-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .metric-name {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .metric-vals {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700;
    }

    .metric-vals .current { color: var(--text); }
    .metric-vals .sep     { color: var(--text-mute); padding: 0 4px; }
    .metric-vals .target  { color: var(--text-mute); font-size: 13px; }

    .metric-check {
      font-size: 16px;
    }

    .progress-bar-track {
      height: 4px;
      background: var(--border2);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .fill-green  { background: var(--green); }
    .fill-yellow { background: var(--yellow); }
    .fill-red    { background: var(--red); }
    .fill-gold   { background: var(--gold); }

    /* ── CHARTS ── */
    .chart-section {
      padding: 0 16px 16px;
    }

    .chart-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 64px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 10px 0;
    }

    .bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      flex: 1;
    }

    .bar {
      width: 100%;
      border-radius: 2px 2px 0 0;
      background: var(--gold);
      min-height: 2px;
      transition: height 0.3s;
    }

    .bar-x {
      font-size: 9px;
      color: var(--text-mute);
      letter-spacing: 0.04em;
    }

    /* ── PHASES SCREEN ── */
    .phases-list {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .phase-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .phase-card.current {
      border-color: var(--gold);
    }

    .phase-card-header {
      display: flex;
      align-items: center;
      padding: 16px 18px;
      cursor: pointer;
      gap: 14px;
    }

    .phase-num {
      font-family: 'JetBrains Mono', monospace;
      font-size: 32px;
      font-weight: 700;
      color: var(--border2);
      line-height: 1;
      width: 40px;
      flex-shrink: 0;
    }

    .phase-card.current .phase-num { color: var(--gold); }
    .phase-card.unlocked .phase-num { color: var(--green); }

    .phase-info { flex: 1; }

    .phase-name {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .phase-desc {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .phase-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      padding: 4px 8px;
      border-radius: 2px;
    }

    .badge-current { background: var(--gold-dim);  color: var(--gold); }
    .badge-locked  { background: var(--surface2); color: var(--text-mute); }
    .badge-ready   { background: var(--green-dim); color: var(--green); }

    .phase-card-body {
      display: none;
      padding: 0 18px 18px;
      border-top: 1px solid var(--border);
    }

    .phase-card-body.open { display: block; }

    .criteria-list {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .criterion {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--surface2);
      border-radius: var(--radius);
    }

    .crit-check {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 11px;
    }

    .crit-check.done {
      border-color: var(--green);
      background: var(--green-dim);
      color: var(--green);
    }

    .crit-text {
      font-size: 14px;
      font-weight: 500;
      flex: 1;
    }

    .crit-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-dim);
    }

    .phase-progress-bar {
      height: 3px;
      background: var(--border2);
      border-radius: 2px;
      margin: 14px 0 0;
      overflow: hidden;
    }

    .phase-progress-fill {
      height: 100%;
      background: var(--gold);
      border-radius: 2px;
      transition: width 0.4s;
    }

    .phase-pct {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 5px;
      text-align: right;
    }

    .unlock-btn {
      width: 100%;
      background: var(--green);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      padding: 14px;
      cursor: pointer;
      margin-top: 14px;
    }

    /* ── BODY SCREEN ── */
    .body-section {
      padding: 16px;
    }

    .body-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .pain-warning {
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: var(--radius);
      padding: 12px 14px;
      margin-bottom: 14px;
      font-size: 13px;
      color: var(--red);
      font-weight: 600;
      letter-spacing: 0.04em;
      display: none;
    }

    .pain-warning.visible { display: block; }

    .check-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .check-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .check-item.checked {
      border-color: var(--gold);
      background: var(--gold-dim);
    }

    .check-box {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border2);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      flex-shrink: 0;
    }

    .check-item.checked .check-box {
      border-color: var(--gold);
      background: var(--gold);
      color: #000;
    }

    .check-text {
      font-size: 14px;
      font-weight: 600;
    }

    .energy-row {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .energy-btn {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-dim);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 12px 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .energy-btn.selected { border-color: var(--gold); color: var(--gold); background: var(--gold-dim); }

    /* ── PROGRESSION SUGGESTION ── */
    .suggestion-banner {
      background: var(--gold-dim);
      border: 1px solid var(--gold);
      border-radius: var(--radius);
      padding: 14px 16px;
      margin: 0 16px 12px;
      display: none;
    }

    .suggestion-banner.visible { display: block; }

    .suggestion-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .suggestion-text {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .suggestion-actions {
      display: flex;
      gap: 8px;
    }

    .sug-accept {
      background: var(--gold);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 8px 16px;
      cursor: pointer;
    }

    .sug-ignore {
      background: none;
      color: var(--text-dim);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 8px 16px;
      cursor: pointer;
    }

    /* ── LEVEL EDITOR ── */
    .level-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .level-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      flex: 1;
    }

    .level-stepper {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .step-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 20px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.1s;
    }

    .step-btn:active { background: var(--border2); }

    .step-val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700;
      min-width: 80px;
      text-align: center;
      color: var(--text);
      padding: 0 4px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .section-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-mute);
      margin-bottom: 12px;
    }

    /* ── STREAK ── */
    .streak-row {
      display: flex;
      gap: 6px;
      padding: 12px 16px 0;
    }

    .streak-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border2);
    }

    .streak-dot.done { background: var(--green); }
    .streak-dot.pain { background: var(--red); }

    /* ── WARMUP SCREEN ── */
    .warmup-today-btn {
      background: var(--gold-dim);
      border: 1px solid var(--gold);
      border-radius: var(--radius);
      color: var(--gold);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 7px 12px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .warmup-status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 12px 16px 4px;
    }

    .warmup-tag {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid;
    }

    .warmup-tag.warn  { background: var(--red-dim);    color: var(--red);    border-color: var(--red); }
    .warmup-tag.caution { background: var(--yellow-dim); color: var(--yellow); border-color: var(--yellow); }
    .warmup-tag.added { background: var(--green-dim);  color: var(--green);  border-color: var(--green); }
    .warmup-tag.info  { background: var(--surface2);   color: var(--text-dim); border-color: var(--border2); }

    .warmup-skip-warning {
      margin: 0 16px 4px;
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-size: 12px;
      color: var(--red);
      font-weight: 600;
      display: none;
    }

    .warmup-skip-warning.visible { display: block; }

    .warmup-list {
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .wu-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .wu-item.done {
      border-color: var(--green);
      opacity: 0.7;
    }

    .wu-item.active {
      border-color: var(--gold);
    }

    .wu-item.added-item {
      border-left: 3px solid var(--green);
    }

    .wu-item.modified-item {
      border-left: 3px solid var(--yellow);
    }

    .wu-row {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      gap: 12px;
    }

    .wu-check {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--border2);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
      font-size: 13px;
      color: transparent;
    }

    .wu-item.done .wu-check {
      border-color: var(--green);
      background: var(--green);
      color: #000;
    }

    .wu-item.active .wu-check {
      border-color: var(--gold);
      animation: pulse-ring 1.5s ease-in-out infinite;
    }

    @keyframes pulse-ring {
      0%, 100% { box-shadow: 0 0 0 0 rgba(200,160,90,0.4); }
      50%       { box-shadow: 0 0 0 5px rgba(200,160,90,0); }
    }

    .wu-info { flex: 1; min-width: 0; }

    .wu-name {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .wu-item.done .wu-name { text-decoration: line-through; color: var(--text-dim); }

    .wu-prescription {
      font-size: 11px;
      color: var(--gold);
      font-weight: 600;
      letter-spacing: 0.06em;
      margin-top: 2px;
    }

    .wu-cue {
      font-size: 11px;
      color: var(--text-dim);
      font-style: italic;
      margin-top: 3px;
      line-height: 1.3;
    }

    .wu-right {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .wu-timer-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      line-height: 1;
    }

    .wu-item.done .wu-timer-display { color: var(--green); }

    .wu-timer-btn {
      background: var(--gold-dim);
      border: 1px solid var(--gold);
      border-radius: var(--radius);
      color: var(--gold);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .wu-timer-btn.running {
      background: var(--red-dim);
      border-color: var(--red);
      color: var(--red);
    }

    .wu-reps-done {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      color: var(--text-dim);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 10px;
      cursor: pointer;
    }

    .wu-item.done .wu-reps-done {
      background: var(--green-dim);
      border-color: var(--green);
      color: var(--green);
    }

    .wu-optional-tag {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--text-mute);
      text-transform: uppercase;
      margin-top: 1px;
    }

    .warmup-footer {
      padding: 4px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .warmup-total-time {
      font-size: 12px;
      color: var(--text-dim);
      text-align: center;
      letter-spacing: 0.06em;
      padding-bottom: 4px;
    }

    .warmup-skip-btn {
      background: none;
      border: none;
      color: var(--text-mute);
      font-family: 'Barlow Condensed', system-ui, sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-align: center;
      cursor: pointer;
      padding: 6px;
    }

    .warmup-complete-banner {
      background: var(--green-dim);
      border: 1px solid var(--green);
      border-radius: var(--radius);
      padding: 10px 14px;
      margin: 0 16px 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--green);
      letter-spacing: 0.06em;
      display: none;
    }

    .warmup-complete-banner.visible { display: block; }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar { width: 0; }
  </style>
</head>
<body>
<div id="app">
  <div class="screens">

    <!-- TODAY -->
    <div class="screen active" id="screen-today">
      <div class="screen-header">
        <div class="phase-tag" id="today-phase-tag">Phase 1 · Week 1 · Day A</div>
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
          <div>
            <div class="screen-title">TODAY</div>
            <div class="screen-subtitle" id="today-goal">Build capacity · Stay pain-free</div>
          </div>
          <button class="warmup-today-btn" onclick="navigateToWarmup()">
            <span>⏱</span> Warmup
          </button>
        </div>
      </div>

      <div class="suggestion-banner" id="suggestion-banner">
        <div class="suggestion-title">⚡ Progression Ready</div>
        <div class="suggestion-text" id="suggestion-text"></div>
        <div class="suggestion-actions">
          <button class="sug-accept" onclick="acceptSuggestion()">Accept</button>
          <button class="sug-ignore" onclick="dismissSuggestion()">Ignore</button>
        </div>
      </div>

      <div class="workout-list" id="workout-list">
        <!-- generated by JS -->
      </div>

      <div class="finish-area">
        <button class="btn-primary" onclick="openFinishModal()">Finish Workout</button>
      </div>
    </div>

    <!-- PROGRESS -->
    <div class="screen" id="screen-progress">
      <div class="screen-header">
        <div class="phase-tag" id="prog-phase-tag">Phase 1</div>
        <div class="screen-title">PROGRESS</div>
        <div class="screen-subtitle">Targets for phase advancement</div>
      </div>

      <div class="progress-section">
        <div class="status-banner not-ready" id="phase-status-banner">
          <div class="status-text" id="phase-status-text">Not Ready</div>
          <div class="status-count" id="phase-status-count">0 / 7</div>
        </div>

        <div id="metrics-list">
          <!-- generated by JS -->
        </div>
      </div>

      <div class="chart-section">
        <div class="chart-label">Pullups — Last 8 sessions</div>
        <div class="bar-chart" id="pullup-chart"></div>
      </div>

      <div class="chart-section" style="margin-top:12px">
        <div class="chart-label">Pain Trend (avg) — Last 8 days</div>
        <div class="bar-chart" id="pain-chart"></div>
      </div>
    </div>

    <!-- PHASES -->
    <div class="screen" id="screen-phases">
      <div class="screen-header">
        <div class="phase-tag">Program Map</div>
        <div class="screen-title">PHASES</div>
        <div class="screen-subtitle">Your progression roadmap</div>
      </div>

      <div class="phases-list" id="phases-list">
        <!-- generated by JS -->
      </div>
    </div>

    <!-- BODY -->
    <div class="screen" id="screen-body">
      <div class="screen-header">
        <div class="phase-tag">Daily Check-In</div>
        <div class="screen-title">BODY</div>
        <div class="screen-subtitle">How do you feel today?</div>
      </div>

      <div class="body-section">
        <div class="pain-warning" id="pain-warning">
          ⚠ Pain elevated for 3+ days. Reduce leverage or repeat previous week.
        </div>

        <div class="body-label">Shoulder Pain</div>
        <div class="pain-row" style="margin-bottom:16px">
          <input type="range" min="0" max="10" value="0" id="body-shoulder" oninput="updateBodyPain('shoulder')" class="low-range">
          <div class="pain-value low" id="body-shoulder-val">0</div>
        </div>

        <div class="body-label">Low Back Pain</div>
        <div class="pain-row" style="margin-bottom:20px">
          <input type="range" min="0" max="10" value="0" id="body-back" oninput="updateBodyPain('back')" class="low-range">
          <div class="pain-value low" id="body-back-val">0</div>
        </div>

        <div class="body-label">Tight Areas</div>
        <div class="check-grid">
          <div class="check-item" onclick="toggleCheck(this, 'ankles')">
            <div class="check-box">✓</div>
            <div class="check-text">Ankles</div>
          </div>
          <div class="check-item" onclick="toggleCheck(this, 'hips')">
            <div class="check-box">✓</div>
            <div class="check-text">Hips</div>
          </div>
          <div class="check-item" onclick="toggleCheck(this, 'thoracic')">
            <div class="check-box">✓</div>
            <div class="check-text">Thoracic</div>
          </div>
          <div class="check-item" onclick="toggleCheck(this, 'neck')">
            <div class="check-box">✓</div>
            <div class="check-text">Neck</div>
          </div>
        </div>

        <div class="body-label">Energy Level</div>
        <div class="energy-row">
          <button class="energy-btn" onclick="selectEnergy(this, 1)">Low</button>
          <button class="energy-btn" onclick="selectEnergy(this, 2)">Fair</button>
          <button class="energy-btn" onclick="selectEnergy(this, 3)">Good</button>
          <button class="energy-btn" onclick="selectEnergy(this, 4)">High</button>
        </div>

        <button class="btn-primary" onclick="saveBodyCheckin()">Save Check-In</button>
      </div>
    </div>

  </div><!-- /screens -->

  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="navigate('today', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Today
    </button>
    <button class="nav-btn" onclick="navigate('progress', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
      </svg>
      Progress
    </button>
    <button class="nav-btn" onclick="navigate('phases', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      Phases
    </button>
    <button class="nav-btn" onclick="navigate('body', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
      Body
    </button>
    <button class="nav-btn" onclick="navigate('warmup', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
      Warmup
    </button>
  </nav>
</div>

    <!-- WARMUP -->
    <div class="screen" id="screen-warmup">
      <div class="screen-header">
        <div class="phase-tag">Pre-Session · 6–10 min</div>
        <div class="screen-title">WARMUP</div>
        <div class="screen-subtitle" id="warmup-subtitle">Back-safe setup: ribs down, pelvis controlled.</div>
      </div>

      <div class="warmup-status-row" id="warmup-status-row">
        <!-- adaptive tags shown here -->
      </div>

      <div class="warmup-skip-warning" id="warmup-skip-warning">
        ⚠ Pain elevated — skipping warmup increases flare risk today.
      </div>

      <div class="warmup-list" id="warmup-list">
        <!-- generated by JS -->
      </div>

      <div class="warmup-footer">
        <div class="warmup-total-time" id="warmup-total-time"></div>
        <button class="btn-primary" onclick="finishWarmup()">Start Workout →</button>
        <button class="warmup-skip-btn" onclick="skipWarmup()" id="warmup-skip-btn">Skip Warmup</button>
      </div>
    </div>


<div class="modal-overlay" id="finish-modal">
  <div class="modal">
    <div class="modal-title">Session Complete</div>

    <div class="body-label">Shoulder Pain (avg)</div>
    <div class="pain-row" style="margin-bottom:16px">
      <input type="range" min="0" max="10" value="0" id="fin-shoulder" oninput="updateFinPain('shoulder')">
      <div class="pain-value low" id="fin-shoulder-val">0</div>
    </div>

    <div class="body-label">Low Back Pain (avg)</div>
    <div class="pain-row" style="margin-bottom:16px">
      <input type="range" min="0" max="10" value="0" id="fin-back" oninput="updateFinPain('back')">
      <div class="pain-value low" id="fin-back-val">0</div>
    </div>

    <div class="body-label">Session Quality</div>
    <div class="quality-btns">
      <button class="q-btn" onclick="selectQuality(this, 'great')">Great</button>
      <button class="q-btn" onclick="selectQuality(this, 'ok')">OK</button>
      <button class="q-btn" onclick="selectQuality(this, 'struggled')">Struggled</button>
    </div>

    <div class="body-label">Notes</div>
    <textarea id="session-notes" placeholder="Any observations..."></textarea>

    <button class="btn-primary" onclick="saveSession()">Save & Update Progress</button>
  </div>
</div>

<script>
// ─────────────────────────────────────────────
//  DATA MODEL & CONSTANTS
// ─────────────────────────────────────────────

const PUSH_LEVELS = [
  'Ring Pushup — Rings at Head Height (Easiest)',
  'Ring Pushup — Rings at Shoulder Height',
  'Ring Pushup — Rings at Chest Height',
  'Ring Pushup — Rings at Waist Height',
  'Ring Pushup — Rings Near Floor',
  'Ring Pushup — Rings at Floor (Hardest)'
];

const PULL_LEVELS = [
  'Dead Hang Hold — Hang Passively, Build Grip & Shoulder Tolerance',
  'Scapular Pulls — Hang & Depress Shoulders, No Elbow Bend',
  'Pullup Negatives — Jump to Top, Lower Yourself Slowly (5–8s)',
  'Ring Rows — Body Angled Under Rings, Pull Chest to Rings',
  'Band-Assisted Pullups — Foot in Band, Full Range of Motion',
  'Full Pullups — Dead Hang to Chin Over Bar'
];

const SQUAT_LEVELS = [
  'Box Squat — Two Legs, Sit Back onto Box, Full Depth',
  'Ring-Assisted Pistol — Hold Rings for Balance, One Leg',
  'Uneven Squat — One Foot Elevated on Ball or Plate',
  'Partial Pistol — One Leg, Lower Halfway Only',
  'Full Pistol Squat — One Leg, Hip Below Knee',
  'Weighted Pistol Squat — Hold Plate or Kettlebell'
];

const CORE_LEVELS = [
  'Dead Bug — Lying, Lower Opposite Arm & Leg Slowly',
  'Bent Hollow Hold — Knees Tucked, Low Back Pressed Flat',
  'Extended Hollow Hold — Legs Straight, Arms Overhead',
  'Tuck Hollow Rock — Rock Back & Forth in Tucked Position',
  'L-Sit Tuck — On Rings or Parallettes, Knees to Chest',
  'Dragon Flag Negative — Lower Body Slowly from Top, Bench',
  'Dragon Flag — Full Body Lowering & Raising, Bench',
  'Hanging L-Sit — Straight Legs Parallel to Floor, Dead Hang'
];

const PHASE_DATA = [
  {
    num: 1,
    name: 'Capacity & Posture',
    desc: 'Build tolerance, joint prep, pain reduction',
    criteria: [
      { key: 'pushLevel',          label: 'Push: Near Floor',     target: 5,  unit: 'level', check: (s) => s.exerciseLevels.push >= 5 },
      { key: 'pullups',            label: '8 Pullups',            target: 8,  unit: 'reps',  check: (s) => s.bestMetrics.pullups >= 8 },
      { key: 'hollowSeconds',      label: 'Hollow Hold 30s',      target: 30, unit: 'sec',   check: (s) => s.bestMetrics.hollowSeconds >= 30 },
      { key: 'supportHoldSeconds', label: 'Ring Support 45s',     target: 45, unit: 'sec',   check: (s) => s.bestMetrics.supportHoldSeconds >= 45 },
      { key: 'pistolsPerLeg',      label: '5 Pistols/leg',        target: 5,  unit: 'reps',  check: (s) => s.bestMetrics.pistolsPerLeg >= 5 },
      { key: 'shoulderPain',       label: 'Shoulder pain ≤2',     target: 2,  unit: 'pain',  check: (s) => getAvgPain('shoulder') <= 2 },
      { key: 'lowBackPain',        label: 'Low back pain ≤2',     target: 2,  unit: 'pain',  check: (s) => getAvgPain('back') <= 2 }
    ]
  },
  {
    num: 2,
    name: 'Strength Transfer',
    desc: 'Load progression, movement mastery',
    criteria: [
      { key: 'pullups',  label: '12 Pullups',        target: 12, unit: 'reps',  check: (s) => s.bestMetrics.pullups >= 12 },
      { key: 'pushLevel',label: 'Floor Pushups',     target: 6,  unit: 'level', check: (s) => s.exerciseLevels.push >= 6 },
      { key: 'pistols',  label: '10 Pistols/leg',    target: 10, unit: 'reps',  check: (s) => s.bestMetrics.pistolsPerLeg >= 10 }
    ]
  },
  {
    num: 3,
    name: 'Mastery',
    desc: 'Advanced strength & skill work',
    criteria: [
      { key: 'pullups',  label: 'Weighted Pullups',  target: 1,  unit: 'reps',  check: (s) => s.bestMetrics.pullups >= 15 }
    ]
  }
];

const DEFAULT_STATE = {
  phase: 1,
  week: 1,
  day: 'A',
  exerciseLevels: { push: 3, pull: 3, squat: 2, core: 2 },
  bestMetrics: { pullups: 0, hollowSeconds: 0, supportHoldSeconds: 0, pistolsPerLeg: 0 },
  painHistory: [],       // [{date, shoulder, back}]
  sessionHistory: [],    // [{date, sets, pain, quality, notes}]
  suggestion: null,      // current pending suggestion
  currentSets: {}        // temp sets during workout
};

let state = loadState();
let finishQuality = 'ok';
let bodyCheckin = { shoulder: 0, back: 0, ankles: false, hips: false, thoracic: false, neck: false, energy: 2 };

// ─────────────────────────────────────────────
//  STORAGE
// ─────────────────────────────────────────────

function loadState() {
  try {
    const s = localStorage.getItem('cc_state_v2');
    if (s) return Object.assign({}, DEFAULT_STATE, JSON.parse(s));
  } catch (e) {}
  return Object.assign({}, DEFAULT_STATE);
}

function saveState() {
  try { localStorage.setItem('cc_state_v2', JSON.stringify(state)); } catch(e) {}
}

// ─────────────────────────────────────────────
//  NAVIGATION
// ─────────────────────────────────────────────

function navigate(tab, btn) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('screen-' + tab).classList.add('active');
  btn.classList.add('active');

  if (tab === 'progress') renderProgress();
  if (tab === 'phases')   renderPhases();
  if (tab === 'body')     renderBody();
  if (tab === 'warmup')   renderWarmup();
}

// ─────────────────────────────────────────────
//  HELPERS
// ─────────────────────────────────────────────

function getAvgPain(type) {
  const recent = state.painHistory.slice(-7);
  if (!recent.length) return 0;
  return recent.reduce((a, b) => a + (b[type] || 0), 0) / recent.length;
}

function getPainClass(v) {
  if (v <= 2) return 'low';
  if (v <= 5) return 'mid';
  return 'high';
}

function getPainRangeClass(v) {
  if (v <= 2) return 'low-range';
  if (v <= 5) return 'mid-range';
  return 'high-range';
}

function updateRangeColor(slider, valEl) {
  const v = parseInt(slider.value);
  const cls = getPainClass(v);
  valEl.textContent = v;
  valEl.className = 'pain-value ' + cls;
  slider.className = getPainRangeClass(v);
}

function today() {
  return new Date().toISOString().split('T')[0];
}

function getMetricValue(criterionKey) {
  const s = state;
  switch(criterionKey) {
    case 'pushLevel':          return s.exerciseLevels.push;
    case 'pullLevel':          return s.exerciseLevels.pull;
    case 'pullups':            return s.bestMetrics.pullups;
    case 'hollowSeconds':      return s.bestMetrics.hollowSeconds;
    case 'supportHoldSeconds': return s.bestMetrics.supportHoldSeconds;
    case 'pistolsPerLeg':      return s.bestMetrics.pistolsPerLeg;
    case 'shoulderPain':       return Math.round(getAvgPain('shoulder') * 10) / 10;
    case 'lowBackPain':        return Math.round(getAvgPain('back') * 10) / 10;
    default: return 0;
  }
}

// ─────────────────────────────────────────────
//  TODAY SCREEN
// ─────────────────────────────────────────────

const LEVEL_MAP = {
  push:     { levels: PUSH_LEVELS,   key: 'push' },
  pull:     { levels: PULL_LEVELS,   key: 'pull' },
  squat:    { levels: SQUAT_LEVELS,  key: 'squat' },
  core:     { levels: CORE_LEVELS,   key: 'core' },
  shoulder: { levels: null,          key: null }
};

const WORKOUTS = [
  {
    id: 'push',
    label: 'PUSH',
    getName: () => PUSH_LEVELS[state.exerciseLevels.push - 1].split(' — ')[0],
    getDesc: () => PUSH_LEVELS[state.exerciseLevels.push - 1].split(' — ')[1] || '',
    getLevel: () => 'Level ' + state.exerciseLevels.push,
    getCurrent: () => state.exerciseLevels.push,
    getMax: () => PUSH_LEVELS.length,
    target: 'Target: 3 sets · Stop at 18–20 reps',
    sets: 3,
    type: 'reps'
  },
  {
    id: 'pull',
    label: 'PULL',
    getName: () => PULL_LEVELS[state.exerciseLevels.pull - 1].split(' — ')[0],
    getDesc: () => PULL_LEVELS[state.exerciseLevels.pull - 1].split(' — ')[1] || '',
    getLevel: () => 'Level ' + state.exerciseLevels.pull,
    getCurrent: () => state.exerciseLevels.pull,
    getMax: () => PULL_LEVELS.length,
    target: 'Target: 5 sets of 2–5 reps',
    sets: 5,
    type: 'reps'
  },
  {
    id: 'squat',
    label: 'SQUAT',
    getName: () => SQUAT_LEVELS[state.exerciseLevels.squat - 1].split(' — ')[0],
    getDesc: () => SQUAT_LEVELS[state.exerciseLevels.squat - 1].split(' — ')[1] || '',
    getLevel: () => 'Level ' + state.exerciseLevels.squat,
    getCurrent: () => state.exerciseLevels.squat,
    getMax: () => SQUAT_LEVELS.length,
    target: 'Target: 3 × 5–8 per leg',
    sets: 3,
    type: 'reps'
  },
  {
    id: 'core',
    label: 'CORE',
    getName: () => CORE_LEVELS[state.exerciseLevels.core - 1].split(' — ')[0],
    getDesc: () => CORE_LEVELS[state.exerciseLevels.core - 1].split(' — ')[1] || '',
    getLevel: () => 'Level ' + state.exerciseLevels.core,
    getCurrent: () => state.exerciseLevels.core,
    getMax: () => CORE_LEVELS.length,
    target: 'Target: 3 × max hold (seconds)',
    sets: 3,
    type: 'time'
  },
  {
    id: 'shoulder',
    label: 'SHOULDER',
    getName: () => 'Ring Support Hold',
    getDesc: () => 'Arms Locked, Body Vertical, Rings Turned Out',
    getLevel: () => 'Stability work',
    getCurrent: () => null,
    getMax: () => null,
    target: 'Target: 3 × 20–45 seconds',
    sets: 3,
    type: 'time'
  }
];

function renderToday() {
  // Header
  document.getElementById('today-phase-tag').textContent =
    `Phase ${state.phase} · Week ${state.week} · Day ${state.day}`;

  const goals = { 1: 'Build capacity · Stay pain-free', 2: 'Strength transfer · Load progression', 3: 'Skill mastery' };
  document.getElementById('today-goal').textContent = goals[state.phase] || '';

  // Cards
  const list = document.getElementById('workout-list');
  list.innerHTML = WORKOUTS.map(w => `
    <div class="workout-card" id="card-${w.id}">
      <div class="card-header" onclick="toggleCard('${w.id}')">
        <div class="card-label">${w.label}</div>
        <div>
          <div class="card-name">${w.getName()}</div>
          <div class="card-desc">${w.getDesc()}</div>
          <div class="card-level">${w.getLevel()}</div>
        </div>
        <div class="card-chevron" id="chev-${w.id}">▼</div>
      </div>
      <div class="card-body" id="body-${w.id}">
        ${w.getCurrent() !== null ? `
        <div class="card-level-stepper">
          <div class="cls-label">Change Level</div>
          <div class="cls-controls">
            <button class="cls-btn" onclick="changeLevel('${w.id}', -1, event)"
              ${w.getCurrent() <= 1 ? 'disabled' : ''}>←</button>
            <div class="cls-display">
              <div class="cls-num">${w.getCurrent()} <span class="cls-of">/ ${w.getMax()}</span></div>
              <div class="cls-name" id="cls-name-${w.id}">${w.getName()}</div>
              <div class="cls-desc" id="cls-desc-${w.id}">${w.getDesc()}</div>
            </div>
            <button class="cls-btn" onclick="changeLevel('${w.id}', +1, event)"
              ${w.getCurrent() >= w.getMax() ? 'disabled' : ''}>→</button>
          </div>
        </div>
        ` : ''}
        <div class="target-line"><strong>${w.target}</strong></div>
        <div class="sets-grid">
          ${Array.from({length: w.sets}, (_, i) => `
            <div class="set-field">
              <div class="set-label">Set ${i+1}</div>
              <input class="set-input ${w.type === 'time' ? 'time-input' : ''}"
                type="number" inputmode="numeric" min="0" max="999"
                id="set-${w.id}-${i}"
                placeholder="${w.type === 'time' ? '0s' : '0'}"
                onchange="recordSet('${w.id}', ${i}, this.value)">
            </div>
          `).join('')}
        </div>
        <div class="pain-row">
          <div class="pain-label">Pain</div>
          <input type="range" min="0" max="10" value="0" class="low-range"
            id="pain-${w.id}" oninput="updateWorkoutPain('${w.id}', this)">
          <div class="pain-value low" id="pain-val-${w.id}">0</div>
        </div>
      </div>
    </div>
  `).join('');

  // Suggestion
  if (state.suggestion) {
    document.getElementById('suggestion-text').textContent = state.suggestion.text;
    document.getElementById('suggestion-banner').classList.add('visible');
  }
}

function toggleCard(id) {
  const body = document.getElementById('body-' + id);
  const chev = document.getElementById('chev-' + id);
  const isOpen = body.classList.toggle('open');
  chev.classList.toggle('open', isOpen);
}

function changeLevel(id, delta, event) {
  event.stopPropagation(); // prevent card toggle
  const keyMap = { push: 'push', pull: 'pull', squat: 'squat', core: 'core' };
  const key = keyMap[id];
  if (!key) return;

  const levelMap = { push: PUSH_LEVELS, pull: PULL_LEVELS, squat: SQUAT_LEVELS, core: CORE_LEVELS };
  const levels = levelMap[id];
  const current = state.exerciseLevels[key];
  const newLevel = Math.max(1, Math.min(levels.length, current + delta));
  if (newLevel === current) return;

  state.exerciseLevels[key] = newLevel;
  saveState();

  // Update display in-place without full re-render
  const w = WORKOUTS.find(w => w.id === id);
  const nameEl = document.getElementById('cls-name-' + id);
  const descEl = document.getElementById('cls-desc-' + id);
  if (nameEl) nameEl.textContent = w.getName();
  if (descEl) descEl.textContent = w.getDesc();

  // Update the num display
  const stepperEl = document.querySelector(`#body-${id} .cls-num`);
  if (stepperEl) stepperEl.innerHTML = `${newLevel} <span class="cls-of">/ ${levels.length}</span>`;

  // Update card header name too
  document.querySelector(`#card-${id} .card-name`).textContent = w.getName();
  document.querySelector(`#card-${id} .card-desc`).textContent = w.getDesc();
  document.querySelector(`#card-${id} .card-level`).textContent = w.getLevel();

  // Disable/enable buttons
  const btns = document.querySelectorAll(`#body-${id} .cls-btn`);
  btns[0].disabled = newLevel <= 1;
  btns[1].disabled = newLevel >= levels.length;
}

function recordSet(exerciseId, setIdx, value) {
  if (!state.currentSets[exerciseId]) state.currentSets[exerciseId] = [];
  state.currentSets[exerciseId][setIdx] = parseInt(value) || 0;
}

function updateWorkoutPain(id, slider) {
  const val = document.getElementById('pain-val-' + id);
  updateRangeColor(slider, val);
}

function openFinishModal() {
  document.getElementById('fin-shoulder').value = 0;
  document.getElementById('fin-back').value = 0;
  document.getElementById('fin-shoulder-val').textContent = '0';
  document.getElementById('fin-back-val').textContent = '0';
  document.getElementById('fin-shoulder-val').className = 'pain-value low';
  document.getElementById('fin-back-val').className = 'pain-value low';
  document.getElementById('fin-shoulder').className = 'low-range';
  document.getElementById('fin-back').className = 'low-range';
  document.getElementById('session-notes').value = '';
  finishQuality = 'ok';
  document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('finish-modal').classList.add('open');
}

function updateFinPain(type) {
  const slider = document.getElementById('fin-' + type);
  const valEl  = document.getElementById('fin-' + type + '-val');
  updateRangeColor(slider, valEl);
}

function selectQuality(btn, q) {
  document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  finishQuality = q;
}

function saveSession() {
  const shoulder = parseInt(document.getElementById('fin-shoulder').value);
  const back     = parseInt(document.getElementById('fin-back').value);
  const notes    = document.getElementById('session-notes').value;

  // Save session
  const session = {
    date: today(),
    sets: Object.assign({}, state.currentSets),
    pain: { shoulder, back },
    quality: finishQuality,
    notes
  };
  state.sessionHistory.push(session);

  // Update pain history
  const existingPain = state.painHistory.find(p => p.date === today());
  if (existingPain) {
    existingPain.shoulder = shoulder;
    existingPain.back = back;
  } else {
    state.painHistory.push({ date: today(), shoulder, back });
  }

  // Update best metrics from pull sets
  const pullSets = state.currentSets.pull || [];
  const maxPull = Math.max(...pullSets, 0);
  if (maxPull > state.bestMetrics.pullups) state.bestMetrics.pullups = maxPull;

  const coreSets = state.currentSets.core || [];
  const maxCore = Math.max(...coreSets, 0);
  if (maxCore > state.bestMetrics.hollowSeconds) state.bestMetrics.hollowSeconds = maxCore;

  const shoulderSets = state.currentSets.shoulder || [];
  const maxShoulder = Math.max(...shoulderSets, 0);
  if (maxShoulder > state.bestMetrics.supportHoldSeconds) state.bestMetrics.supportHoldSeconds = maxShoulder;

  const squatSets = state.currentSets.squat || [];
  const maxSquat = Math.max(...squatSets, 0);
  if (maxSquat > state.bestMetrics.pistolsPerLeg) state.bestMetrics.pistolsPerLeg = maxSquat;

  // Check progression
  checkProgression(session);

  // Advance day
  if (state.day === 'A') {
    state.day = 'B';
  } else {
    state.day = 'A';
    state.week++;
  }

  state.currentSets = {};

  saveState();
  document.getElementById('finish-modal').classList.remove('open');
  renderToday();
}

function checkProgression(session) {
  // Push progression check
  const pushSets = session.sets.push || [];
  if (pushSets.length >= 2) {
    const total = pushSets.reduce((a,b) => a+b, 0);
    const first = pushSets[0] || 1;
    const last  = pushSets[pushSets.length-1] || 0;
    const pain  = session.pain.shoulder;
    if (total >= 45 && last >= first * 0.75 && pain <= 2 && state.exerciseLevels.push < 6) {
      state.suggestion = {
        type: 'push',
        text: `Push: ${total} total reps with pain ≤2. Lower rings 1–2 inches next session.`
      };
    }
  }

  // Pull progression check
  const pullSets = session.sets.pull || [];
  const pullTotal = pullSets.reduce((a,b) => a+b, 0);
  if (pullTotal >= 15 && session.pain.shoulder <= 2 && state.exerciseLevels.pull < 6) {
    if (!state.suggestion) state.suggestion = {
      type: 'pull',
      text: `Pull: Strong session with ${pullTotal} total reps. Consider advancing to next level.`
    };
  }
}

function acceptSuggestion() {
  if (!state.suggestion) return;
  if (state.suggestion.type === 'push') {
    state.exerciseLevels.push = Math.min(6, state.exerciseLevels.push + 1);
  } else if (state.suggestion.type === 'pull') {
    state.exerciseLevels.pull = Math.min(6, state.exerciseLevels.pull + 1);
  }
  state.suggestion = null;
  saveState();
  document.getElementById('suggestion-banner').classList.remove('visible');
  renderToday();
}

function dismissSuggestion() {
  state.suggestion = null;
  saveState();
  document.getElementById('suggestion-banner').classList.remove('visible');
}

// ─────────────────────────────────────────────
//  PROGRESS SCREEN
// ─────────────────────────────────────────────

function renderProgress() {
  document.getElementById('prog-phase-tag').textContent = 'Phase ' + state.phase;

  const phaseData = PHASE_DATA[state.phase - 1];
  const criteria  = phaseData.criteria;

  let metMet = 0;
  const metricsHTML = criteria.map(c => {
    const current = getMetricValue(c.key);
    const met     = c.check(state);
    if (met) metMet++;

    const pct = c.unit === 'pain'
      ? (current <= c.target ? 100 : Math.max(0, 100 - (current - c.target) * 20))
      : Math.min(100, (current / c.target) * 100);

    const fillClass = pct >= 100 ? 'fill-green' : pct >= 65 ? 'fill-yellow' : 'fill-gold';

    const displayCurrent = c.unit === 'pain' ? current.toFixed(1) : current;
    const targetLabel    = c.unit === 'pain' ? '≤' + c.target : c.target + (c.unit === 'sec' ? 's' : c.unit === 'level' ? '' : '');

    return `
      <div class="metric-card">
        <div class="metric-row">
          <div class="metric-name">${c.label}</div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="metric-vals">
              <span class="current">${displayCurrent}</span>
              <span class="sep">/</span>
              <span class="target">${targetLabel}</span>
            </div>
            <div class="metric-check">${met ? '✅' : '⬜'}</div>
          </div>
        </div>
        <div class="progress-bar-track">
          <div class="progress-bar-fill ${fillClass}" style="width:${pct}%"></div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('metrics-list').innerHTML = metricsHTML;

  const allMet  = metMet === criteria.length;
  const banner  = document.getElementById('phase-status-banner');
  const text    = document.getElementById('phase-status-text');
  const count   = document.getElementById('phase-status-count');

  banner.className = 'status-banner ' + (allMet ? 'ready' : 'not-ready');
  text.textContent = allMet ? 'Phase ' + (state.phase + 1) + ' Ready!' : 'Keep Building';
  count.textContent = metMet + ' / ' + criteria.length;

  // Charts
  renderPullupChart();
  renderPainChart();
}

function renderPullupChart() {
  const sessions = state.sessionHistory.slice(-8);
  const container = document.getElementById('pullup-chart');
  if (!sessions.length) { container.innerHTML = '<div style="color:var(--text-mute);font-size:12px;padding:8px">No data yet</div>'; return; }

  const vals   = sessions.map(s => Math.max(...(s.sets.pull || [0]), 0));
  const maxVal = Math.max(...vals, 1);

  container.innerHTML = vals.map((v, i) => {
    const h = Math.max(4, Math.round((v / maxVal) * 48));
    return `
      <div class="bar-col">
        <div class="bar" style="height:${h}px;background:var(--gold)"></div>
        <div class="bar-x">${v}</div>
      </div>
    `;
  }).join('');
}

function renderPainChart() {
  const history = state.painHistory.slice(-8);
  const container = document.getElementById('pain-chart');
  if (!history.length) { container.innerHTML = '<div style="color:var(--text-mute);font-size:12px;padding:8px">No data yet</div>'; return; }

  container.innerHTML = history.map((p, i) => {
    const avg = ((p.shoulder || 0) + (p.back || 0)) / 2;
    const h   = Math.max(2, Math.round((avg / 10) * 48));
    const col = avg <= 2 ? 'var(--green)' : avg <= 5 ? 'var(--yellow)' : 'var(--red)';
    return `
      <div class="bar-col">
        <div class="bar" style="height:${h}px;background:${col}"></div>
        <div class="bar-x">${avg.toFixed(1)}</div>
      </div>
    `;
  }).join('');
}

// ─────────────────────────────────────────────
//  PHASES SCREEN
// ─────────────────────────────────────────────

function renderPhases() {
  const html = PHASE_DATA.map(phase => {
    const isCurrent  = phase.num === state.phase;
    const isUnlocked = phase.num < state.phase;
    const isLocked   = phase.num > state.phase;

    const phaseClass = isCurrent ? 'current' : isUnlocked ? 'unlocked' : '';
    const badge = isCurrent  ? '<span class="phase-badge badge-current">Current</span>'
                : isUnlocked ? '<span class="phase-badge badge-ready">Complete</span>'
                : '<span class="phase-badge badge-locked">Locked</span>';

    const criteria = phase.criteria;
    let metCount = 0;
    const criteriaHTML = criteria.map(c => {
      const met = c.check(state);
      if (met) metCount++;
      const current = getMetricValue(c.key);
      const displayCurrent = c.unit === 'pain' ? current.toFixed(1) : current;
      return `
        <div class="criterion">
          <div class="crit-check ${met ? 'done' : ''}">✓</div>
          <div class="crit-text">${c.label}</div>
          <div class="crit-val">${displayCurrent}</div>
        </div>
      `;
    }).join('');

    const pct = Math.round((metCount / criteria.length) * 100);

    const unlockBtn = (isCurrent && metCount === criteria.length)
      ? `<button class="unlock-btn" onclick="advancePhase()">🔓 Advance to Phase ${state.phase + 1}</button>`
      : '';

    return `
      <div class="phase-card ${phaseClass}">
        <div class="phase-card-header" onclick="togglePhaseCard(${phase.num})">
          <div class="phase-num">${String(phase.num).padStart(2,'0')}</div>
          <div class="phase-info">
            <div class="phase-name">${phase.name}</div>
            <div class="phase-desc">${phase.desc}</div>
          </div>
          ${badge}
        </div>
        <div class="phase-card-body ${isCurrent ? 'open' : ''}" id="phase-body-${phase.num}">
          <div class="criteria-list">${criteriaHTML}</div>
          <div class="phase-progress-bar">
            <div class="phase-progress-fill" style="width:${pct}%"></div>
          </div>
          <div class="phase-pct">${metCount} / ${criteria.length} criteria · ${pct}%</div>
          ${unlockBtn}
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('phases-list').innerHTML = html;
}

function togglePhaseCard(num) {
  const body = document.getElementById('phase-body-' + num);
  body.classList.toggle('open');
}

function advancePhase() {
  if (state.phase < 3) {
    state.phase++;
    state.week = 1;
    state.day  = 'A';
    saveState();
    renderPhases();
    renderToday();
  }
}

// ─────────────────────────────────────────────
//  BODY SCREEN
// ─────────────────────────────────────────────

function renderBody() {
  // Check 3-day pain warning
  const recent = state.painHistory.slice(-3);
  const warned  = recent.length === 3 && recent.every(p => (p.shoulder > 3 || p.back > 3));
  const warning = document.getElementById('pain-warning');
  warning.classList.toggle('visible', warned);
}

function updateBodyPain(type) {
  const slider = document.getElementById('body-' + type);
  const valEl  = document.getElementById('body-' + type + '-val');
  updateRangeColor(slider, valEl);
  bodyCheckin[type] = parseInt(slider.value);
}

function toggleCheck(el, key) {
  el.classList.toggle('checked');
  bodyCheckin[key] = el.classList.contains('checked');
}

function selectEnergy(btn, level) {
  document.querySelectorAll('.energy-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  bodyCheckin.energy = level;
}

function saveBodyCheckin() {
  const shoulder = parseInt(document.getElementById('body-shoulder').value);
  const back     = parseInt(document.getElementById('body-back').value);

  const existingPain = state.painHistory.find(p => p.date === today());
  if (existingPain) {
    existingPain.shoulder = shoulder;
    existingPain.back = back;
  } else {
    state.painHistory.push({ date: today(), shoulder, back });
  }

  saveState();

  // Flash confirmation
  const btn = document.querySelector('#screen-body .btn-primary');
  const orig = btn.textContent;
  btn.textContent = 'Saved ✓';
  btn.style.background = 'var(--green)';
  setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 1500);

  renderBody();
}

// ─────────────────────────────────────────────
//  WARMUP ENGINE
// ─────────────────────────────────────────────

const WARMUP_BASE = [
  { id: 'breathing', name: '90/90 Breathing Reset', type: 'timer', duration: 60,
    prescription: '5–6 slow breaths · ~60 sec',
    cue: 'Exhale, ribs down, flatten low back. Hold 3–4 sec each breath.' },
  { id: 'glute_bridge', name: 'Posterior Tilt Glute Bridge', type: 'reps', sets: 2, reps: 10,
    prescription: '2 × 10 reps',
    cue: 'Flatten low back first, tuck pelvis, lift with glutes. Lower slowly. No arching at top.' },
  { id: 'dead_bug', name: 'Dead Bug', type: 'reps', sets: 2, reps: 8, perSide: true,
    prescription: '2 × 8 per side',
    cue: 'Low back stays pinned flat. If back lifts — shorten the range.' },
  { id: 'ankle_wall', name: 'Knee-to-Wall Ankle Mobility', type: 'reps', sets: 2, reps: 10, perSide: true,
    prescription: '2 × 10 per ankle',
    cue: 'Heel stays down. Drive knee forward to wall. Move foot back as range improves.' },
  { id: 'deep_squat', name: 'Supported Deep Squat Rock', type: 'timer', duration: 60,
    prescription: '60 sec',
    cue: 'Hold rings or rack. Heels down, chest tall, shift side to side. Low back neutral — not arched.' },
  { id: 'hip_flexor', name: 'Half-Kneeling Hip Flexor Stretch', type: 'timer', duration: 30, perSide: true,
    prescription: '30 sec per side',
    cue: 'Posterior tilt first — tuck pelvis, then shift forward. Skipping tilt = stretching spine, not hip.' },
  { id: 'hips_90_90', name: '90/90 Hip Rotations', type: 'timer', duration: 90,
    prescription: '1–2 minutes',
    cue: 'Stay tall. Rotate slowly side to side from the hips. Improves pistol control and knee tracking.' },
  { id: 'hang', name: 'Hanging Decompression', type: 'timer', duration: 25, optional: true,
    prescription: 'Optional · 20–30 sec',
    cue: 'Dead hang from rings or bar. Light core engagement — do not arch.' }
];

// Active timer state
let warmupTimers = {};       // { itemId: intervalId }
let warmupTimeLeft = {};     // { itemId: secondsLeft }
let warmupDone = new Set();  // completed item ids
let activeWarmupRoutine = [];// final adapted routine

function getTodayPain() {
  const todayEntry = state.painHistory.find(p => p.date === today());
  return {
    shoulder: todayEntry ? (todayEntry.shoulder || 0) : 0,
    back:     todayEntry ? (todayEntry.back || 0) : 0
  };
}

function getTodayTightness() {
  // Pull from bodyCheckin (in-memory from current session)
  return {
    ankles:   bodyCheckin.ankles   || false,
    hips:     bodyCheckin.hips     || false,
    thoracic: bodyCheckin.thoracic || false
  };
}

function buildWarmupRoutine() {
  // Deep-clone base
  let routine = WARMUP_BASE.map(item => Object.assign({}, item));
  const pain      = getTodayPain();
  const tight     = getTodayTightness();
  const tags      = [];
  const addedIds  = new Set();
  const removeIds = new Set();

  // ── Rule A: Low Back ──
  if (pain.back >= 4) {
    tags.push({ label: 'Back Pain ' + pain.back + '/10', cls: 'warn' });
    // Extra breathing set
    routine.splice(1, 0, {
      id: 'breathing_extra', name: '90/90 Breathing (Extra Set)', type: 'timer', duration: 60,
      prescription: '+60 sec · pain modifier',
      cue: 'Slow exhales. Flatten low back completely before moving on.',
      added: true
    });
    addedIds.add('breathing_extra');
    // Remove hanging decompression
    removeIds.add('hang');
    tags.push({ label: '+ Extra Breathing', cls: 'added' });
    tags.push({ label: 'Hang Removed', cls: 'caution' });
  } else if (pain.back >= 1) {
    tags.push({ label: 'Back ' + pain.back + '/10', cls: 'caution' });
  }

  // ── Rule B: Shoulder ──
  if (pain.shoulder >= 4) {
    tags.push({ label: 'Shoulder ' + pain.shoulder + '/10', cls: 'warn' });
    routine.push({
      id: 'wall_slides', name: 'Scapular Wall Slides', type: 'reps', sets: 2, reps: 12,
      prescription: '2 × 12 · shoulder modifier',
      cue: 'Ribs down. Arms in W shape on wall, slide up to Y. Keep low back flat.',
      added: true
    });
    addedIds.add('wall_slides');
    removeIds.add('hang');
    tags.push({ label: '+ Wall Slides', cls: 'added' });
    tags.push({ label: '⚠ Elbows close on rings today', cls: 'caution' });
  } else if (pain.shoulder >= 1) {
    tags.push({ label: 'Shoulder ' + pain.shoulder + '/10', cls: 'caution' });
  }

  // ── Rule C: Ankles ──
  if (tight.ankles) {
    tags.push({ label: '+ Ankle Protocol', cls: 'added' });
    routine = routine.map(item => {
      if (item.id === 'ankle_wall') return Object.assign({}, item, { sets: 3, prescription: '3 × 10 per ankle (upgraded)', modified: true });
      if (item.id === 'deep_squat') return Object.assign({}, item, { duration: 90, prescription: '90 sec (upgraded)', modified: true });
      return item;
    });
    routine.push({
      id: 'calf_iso', name: 'Calf Iso Stretch', type: 'timer', duration: 30, perSide: true,
      prescription: '30 sec per side · ankle modifier',
      cue: 'Heel firmly down, knee straight. Hold steady — feel the pull in the calf/achilles.',
      added: true
    });
    addedIds.add('calf_iso');
  }

  // ── Rule D: Hips ──
  if (tight.hips) {
    tags.push({ label: '+ Hip Protocol', cls: 'added' });
    routine = routine.map(item => {
      if (item.id === 'glute_bridge') return Object.assign({}, item, { sets: 3, prescription: '3 × 10 reps (upgraded)', modified: true });
      return item;
    });
  }

  // ── Rule E: Thoracic ──
  if (tight.thoracic) {
    tags.push({ label: '+ Thoracic Protocol', cls: 'added' });
    routine.push({
      id: 'wall_slides_thor', name: 'Thoracic Wall Slides', type: 'reps', sets: 2, reps: 12,
      prescription: '2 × 12 · thoracic modifier',
      cue: 'Stand with back to wall. Arms in W, slide up to Y. Reach tall, ribs down.',
      added: true
    });
    addedIds.add('wall_slides_thor');
  }

  // Remove flagged items
  routine = routine.filter(item => !removeIds.has(item.id));

  return { routine, tags };
}

function formatTime(sec) {
  if (sec >= 60) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return s === 0 ? `${m}:00` : `${m}:${String(s).padStart(2,'0')}`;
  }
  return sec + 's';
}

function getTotalWarmupMinutes(routine) {
  let total = 0;
  routine.forEach(item => {
    if (item.type === 'timer') {
      total += (item.duration || 30) * (item.perSide ? 2 : 1);
    } else {
      // estimate ~20 sec per set
      total += (item.sets || 2) * 20;
    }
  });
  return Math.round(total / 60);
}

function renderWarmup() {
  warmupTimers  = {};
  warmupTimeLeft = {};
  warmupDone    = new Set();

  const { routine, tags } = buildWarmupRoutine();
  activeWarmupRoutine = routine;

  const pain = getTodayPain();

  // Subtitle
  const sub = document.getElementById('warmup-subtitle');
  sub.textContent = pain.back >= 4 || pain.shoulder >= 4
    ? 'Modified for today\'s pain. Take it slow.'
    : 'Back-safe setup: ribs down, pelvis controlled.';

  // Tags
  const tagRow = document.getElementById('warmup-status-row');
  if (tags.length) {
    tagRow.innerHTML = tags.map(t => `<span class="warmup-tag ${t.cls}">${t.label}</span>`).join('');
  } else {
    tagRow.innerHTML = '<span class="warmup-tag info">All clear · Base routine</span>';
  }

  // Skip warning
  const skipWarn = document.getElementById('warmup-skip-warning');
  skipWarn.classList.toggle('visible', pain.back > 3 || pain.shoulder > 3);

  // Total time
  const mins = getTotalWarmupMinutes(routine);
  document.getElementById('warmup-total-time').textContent = `Estimated time: ${mins}–${mins + 2} min`;

  // Render items
  const list = document.getElementById('warmup-list');
  list.innerHTML = routine.map((item, idx) => {
    const isTimer = item.type === 'timer';
    const initTime = item.duration || 30;
    warmupTimeLeft[item.id] = initTime;

    const extraClass = item.added ? 'added-item' : item.modified ? 'modified-item' : '';

    const rightHTML = isTimer
      ? `<div class="wu-right">
           <div class="wu-timer-display" id="timer-disp-${item.id}">${formatTime(initTime)}</div>
           <button class="wu-timer-btn" id="timer-btn-${item.id}"
             onclick="toggleTimer('${item.id}', ${initTime})">Start</button>
         </div>`
      : `<div class="wu-right">
           <button class="wu-reps-done" onclick="markDone('${item.id}')">Done</button>
         </div>`;

    return `
      <div class="wu-item ${extraClass}" id="wu-${item.id}">
        <div class="wu-row">
          <div class="wu-check" onclick="markDone('${item.id}')">✓</div>
          <div class="wu-info">
            <div class="wu-name">${item.name}</div>
            <div class="wu-prescription">${item.prescription}${item.perSide ? ' · per side' : ''}</div>
            <div class="wu-cue">"${item.cue}"</div>
            ${item.optional ? '<div class="wu-optional-tag">Optional</div>' : ''}
          </div>
          ${rightHTML}
        </div>
      </div>
    `;
  }).join('');
}

function toggleTimer(itemId, initSec) {
  if (warmupTimers[itemId]) {
    // Pause
    clearInterval(warmupTimers[itemId]);
    delete warmupTimers[itemId];
    const btn = document.getElementById('timer-btn-' + itemId);
    if (btn) { btn.textContent = 'Resume'; btn.classList.remove('running'); }
  } else {
    // Start / Resume
    const btn = document.getElementById('timer-btn-' + itemId);
    const disp = document.getElementById('timer-disp-' + itemId);
    if (btn) { btn.textContent = 'Pause'; btn.classList.add('running'); }

    // Mark as active
    const el = document.getElementById('wu-' + itemId);
    if (el) el.classList.add('active');

    warmupTimers[itemId] = setInterval(() => {
      warmupTimeLeft[itemId] = (warmupTimeLeft[itemId] || initSec) - 1;
      const left = warmupTimeLeft[itemId];

      if (disp) disp.textContent = formatTime(Math.max(0, left));

      if (left <= 0) {
        clearInterval(warmupTimers[itemId]);
        delete warmupTimers[itemId];
        markDone(itemId);
      }
    }, 1000);
  }
}

function markDone(itemId) {
  // Stop any running timer
  if (warmupTimers[itemId]) {
    clearInterval(warmupTimers[itemId]);
    delete warmupTimers[itemId];
  }

  warmupDone.add(itemId);
  const el = document.getElementById('wu-' + itemId);
  if (el) {
    el.classList.add('done');
    el.classList.remove('active');
  }

  const btn = document.getElementById('timer-btn-' + itemId);
  if (btn) { btn.textContent = '✓ Done'; btn.classList.remove('running'); }

  // Check if all done
  const allDone = activeWarmupRoutine.every(item => warmupDone.has(item.id));
  if (allDone) {
    // Show complete banner
    let banner = document.getElementById('warmup-complete-banner');
    if (!banner) {
      banner = document.createElement('div');
      banner.id = 'warmup-complete-banner';
      banner.className = 'warmup-complete-banner';
      banner.textContent = '✓ Warmup Complete — Ready to Train';
      document.getElementById('warmup-list').after(banner);
    }
    banner.classList.add('visible');
  }
}

function finishWarmup() {
  // Log warmup completion
  const todayEntry = state.painHistory.find(p => p.date === today());
  if (todayEntry) todayEntry.warmupDone = true;
  saveState();

  // Navigate to Today
  const todayBtn = document.querySelector('.nav-btn');
  navigate('today', todayBtn);
}

function skipWarmup() {
  const pain = getTodayPain();
  if (pain.back > 3 || pain.shoulder > 3) {
    const confirmed = confirm('Pain is elevated today. Skipping warmup increases flare risk. Are you sure?');
    if (!confirmed) return;
  }
  const todayBtn = document.querySelector('.nav-btn');
  navigate('today', todayBtn);
}

function navigateToWarmup() {
  const warmupBtn = document.querySelectorAll('.nav-btn')[4];
  navigate('warmup', warmupBtn);
}

// ─────────────────────────────────────────────
//  INIT
// ─────────────────────────────────────────────

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

renderToday();
</script>
</body>
</html>
